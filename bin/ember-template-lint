#!/usr/bin/env node

'use strict';

const path = require('path');
const fs = require('fs');
const Linter = require('../lib/index');

function errorsToMessages(errors) {
  return errors.map((error) => {
    let message = `${error.rule}: ${error.message} (${error.moduleId}`;

    if (error.line && error.column) {
      message += ` @ L${error.line}:C${error.column}`;
    }

    message += ')';

    if (error.source) message += `: \n\`${error.source}\``;

    return message;
  }).join('\n');
}

function lintFile(filePath, moduleId) {
  const linter = new Linter();
  const source = fs.readFileSync(filePath, { encoding: 'utf8' });
  return linter.verify({ source, moduleId });
}

function run() {
  const relativeFilePath = process.argv.find((arg) => arg.slice(-4) === '.hbs');
  const filePath = path.resolve(relativeFilePath);
  const errors = lintFile(filePath, relativeFilePath.slice(0, -4));

  if (process.argv.indexOf('--json') + 1) {
    console.log(JSON.stringify({ [filePath]: errors }, null, 2));
  } else {
    console.log(errorsToMessages(errors));
  }

  if (errors.some((err) => err.severity > 1).length) process.exit(1);
}

run();
